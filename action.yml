name: 'Create Deployment Matrix'
description: 'Creates a matrix for service deployment based on .koala-monorepo.json and .koala.toml configuration'
author: 'Skyhook'

branding:
  icon: 'grid'
  color: 'purple'

inputs:
  overlay:
    description: 'The overlay/environment to use for kustomize (e.g., dev, staging, production). If not provided, all environments will be included.'
    required: false
  branch:
    description: 'The branch to use for deployment'
    required: false
    default: 'main'
  tag:
    description: 'The image tag to deploy'
    required: true
  github-token:
    description: 'GitHub token for API access'
    required: true
  repo-path:
    description: 'The path to the repo'
    required: false
    default: '.'

outputs:
  matrix:
    description: 'A JSON matrix for service deployments containing service and environment combinations'
    value: ${{ fromJSON(steps.create-matrix.outputs.matrix) }}
  matrix-json:
    description: 'Raw JSON string of the matrix'
    value: ${{ steps.create-matrix.outputs.matrix-json }}

runs:
  using: "composite"
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        set -euo pipefail

        if [[ ! -d "${{ inputs.repo-path }}" ]]; then
          echo "::error::Repository path not found: ${{ inputs.repo-path }}"
          exit 1
        fi

        if [[ -z "${{ inputs.tag }}" ]]; then
          echo "::error::tag input is required"
          exit 1
        fi

        if [[ -z "${{ inputs.github-token }}" ]]; then
          echo "::error::github-token input is required"
          exit 1
        fi

    - name: Create matrix for deployment
      id: create-matrix
      working-directory: ${{ inputs.repo-path }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        TAG: ${{ inputs.tag }}
        BRANCH: ${{ inputs.branch }}
        OVERLAY: ${{ inputs.overlay }}
      run: |
        set -euo pipefail

        echo "ðŸ” Reading .koala-monorepo.json from repo root to identify services"
        echo "ðŸ“‹ Extracting deployment configuration from .koala.toml files for different environments"

        # Build the command with conditional overlay filter
        CMD="npx --yes workflow-utils get-services-env-config -dir . -outputFormat github-matrix -branch ${BRANCH} -actionTag ${TAG}"

        if [[ -n "${OVERLAY}" ]]; then
          echo "ðŸŽ¯ Filtering for environment: ${OVERLAY}"
          CMD="${CMD} -envFilter ${OVERLAY}"
        else
          echo "ðŸŒ Including all environments"
        fi

        echo "ðŸ“¦ Executing: ${CMD}"
        MATRIX_RAW=$(eval "${CMD}")

        if [[ -z "${MATRIX_RAW}" ]]; then
          echo "::error::Failed to generate matrix - empty result"
          exit 1
        fi

        echo "Raw output from workflow-utils:"
        echo "${MATRIX_RAW}"

        if echo "${MATRIX_RAW}" | jq -e 'type == "string"' > /dev/null 2>&1; then
          echo "Detected double-encoded JSON, decoding..."
          MATRIX=$(echo "${MATRIX_RAW}" | jq -r '.')
        else
          MATRIX="${MATRIX_RAW}"
        fi

        if ! echo "${MATRIX}" | jq empty 2>/dev/null; then
          echo "::error::Generated matrix is not valid JSON"
          echo "Matrix content: ${MATRIX}"
          exit 1
        fi

        {
          echo "matrix<<EOF"
          echo "${MATRIX}"
          echo "EOF"
        } >> $GITHUB_OUTPUT

        {
          echo "matrix-json<<EOF"
          echo "${MATRIX}"
          echo "EOF"
        } >> $GITHUB_OUTPUT

        echo "âœ… Generated deployment matrix:"
        echo "${MATRIX}" | jq .

    - name: Generate summary
      if: always()
      shell: bash
      working-directory: ${{ inputs.repo-path }}
      run: |
        set -euo pipefail

        echo "## ðŸ“Š Deployment Matrix Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.create-matrix.outcome }}" == "success" ]]; then
          echo "âœ… **Status:** Successfully generated deployment matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ inputs.overlay }}" ]]; then
            echo "- **Environment:** \`${{ inputs.overlay }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Environment:** All environments" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Matrix Output" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.create-matrix.outputs.matrix-json }}' | jq . >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status:** Failed to generate matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
        fi
